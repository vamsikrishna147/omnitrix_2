<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Editor</title>
    <style>
        * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
        }

        :root{
          /* Ben10 dark-green palette */
          --bg-0: #04240b; /* very dark green */
          --bg-1: #073012; /* dark green */
          --panel: #07120b;
          --muted: #cbdad1; /* pale off-white */
          --accent: #0f6b2a; /* dark green for text */
          --accent-2: #58d96b; /* bright green caret */
          --surface: #08120a;
          --glass: rgba(255,255,255,0.03);
          --danger: #ff4d4d;
          --success: #27b862;
        }

        body {
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
          background: linear-gradient(180deg, var(--bg-0), var(--bg-1));
          min-height: 100vh;
          padding: 28px;
          color: var(--muted);
        }

        .container {
          max-width: 1400px;
          margin: 0 auto;
          background: linear-gradient(180deg, rgba(20,30,18,0.6), rgba(7,10,8,0.6));
          border-radius: 8px;
          box-shadow: 0 12px 40px rgba(0,0,0,0.6), inset 0 1px 0 rgba(255,255,255,0.02);
          overflow: hidden;
          border: 1px solid rgba(88,217,107,0.06);
        }

        .header {
          color: var(--muted);
          background: linear-gradient(90deg, rgba(12,24,12,0.95), rgba(20,30,18,0.95));
          padding: 14px 22px;
          display: flex;
          justify-content: space-between;
          align-items: center;
        }

        .header h1 {
          font-size: 20px;
          color: #f5f7fb;
          letter-spacing: -0.2px;
        }

        .header-actions {
          display: flex;
          gap: 10px;
          align-items: center;
        }

        .btn {
          padding: 10px 14px;
          border: none;
          border-radius: 6px;
          cursor: pointer;
          font-size: 13px;
          font-weight: 700;
          transition: transform 120ms ease, box-shadow 120ms ease;
          backdrop-filter: blur(2px);
        }

        .btn-primary {
          background: linear-gradient(180deg,var(--accent-2),var(--accent));
          color: #021403;
          box-shadow: 0 6px 14px rgba(24,88,34,0.12);
        }

        .btn-primary:hover { transform: translateY(-1px); }

        .btn-secondary {
          background: rgba(255,255,255,0.02);
          color: var(--muted);
          border: 1px solid rgba(255,255,255,0.04);
        }

        .btn-outline {
          background: transparent;
          color: var(--muted);
          border: 1px solid rgba(88,217,107,0.12);
        }

        .btn-success { background: linear-gradient(90deg,var(--accent-2),var(--accent)); color: #021403; }
        .btn-danger { background: linear-gradient(90deg,#ff7b7b,var(--danger)); color: white; }

        .main-content { display: grid; grid-template-columns: 260px 1fr; min-height: calc(100vh - 140px); }

        .sidebar {
          background: linear-gradient(180deg, rgba(10,18,10,0.7), rgba(8,12,8,0.7));
          padding: 16px;
          border-right: 1px solid rgba(255,255,255,0.02);
        }

        .sidebar h3 { margin-bottom: 14px; color: var(--muted); font-size: 15px; }

        .file-list { list-style: none; }

        .file-item {
          padding: 10px 12px;
          margin-bottom: 8px;
          background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.00));
          border-radius: 8px;
          cursor: pointer;
          transition: all 0.15s ease;
          display: flex;
          justify-content: space-between;
          align-items: center;
          color: var(--muted);
        }

        .file-item span {
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }


        .file-item:hover { transform: translateY(-2px); box-shadow: 0 6px 18px rgba(2,8,23,0.45); color: #fff; }
        .file-item.active { background: linear-gradient(90deg, rgba(88, 217, 107, 0.15), rgba(67,214,182,0.04)); color: #fff; box-shadow: inset 0 1px 0 rgba(255,255,255,0.02); }

        .delete-btn { background: none; border: none; color: inherit; cursor: pointer; padding: 6px; font-size: 15px; flex-shrink: 0; }

        .new-file-section { margin-top: 22px; padding-top: 18px; border-top: 1px dashed rgba(255,255,255,0.02); }
        .new-file-input { width: 100%; padding: 10px; margin-bottom: 10px; border: none; border-radius: 8px; background: rgba(255,255,255,0.02); color: var(--muted); }

        .editor-area { display: flex; flex-direction: column; padding: 20px; position: relative; }

        .editor-toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; padding-bottom: 14px; border-bottom: 1px solid rgba(255,255,255,0.02); }
        .language-selector {
          padding: 8px 12px;
          border-radius: 8px;
          border: 1px solid rgba(88,217,107,0.10);
          background: linear-gradient(180deg, rgba(5,10,6,0.6), rgba(8,14,8,0.6));
          color: var(--accent-2);
          font-weight: 700;
          -webkit-appearance: none;
          appearance: none;
        }
        .language-selector option { background: var(--surface); color: var(--accent-2); }

        .editor-wrapper { flex: 1; position: relative; border-radius: 10px; overflow: hidden; background: linear-gradient(180deg, var(--surface), rgba(13,17,22,0.6)); border: 1px solid rgba(255,255,255,0.02); }
        .editor-wrapper.drag-over { outline: 3px dashed rgba(124,92,255,0.28); background: rgba(124,92,255,0.02); }

        .editor-with-gutter { display: flex; height: 100%;}
        .gutter { width: 48px; min-width: 48px; background: linear-gradient(180deg,#08121a,#051017); color: #6b8790; padding: 18px 8px; border-right: 1px solid rgba(255,255,255,0.02); font-family: 'Fira Code', monospace; font-size: 15.5px; line-height: 1.6; text-align: right; overflow: hidden; user-select: none; }
        .gutter .line-number {
            display: block;
        }
        .gutter, #codeEditor { height: 100%; overflow: auto; }

        #codeEditor {
          flex: 1;
          font-family: 'Fira Code', 'Courier New', Courier, monospace;
          font-size: 15.5px;
          line-height: 1.6;
          padding: 18px;
          border: none;
          resize: none;
          background: transparent;
          color: var(--accent-2);
          caret-color: var(--accent-2);
          white-space: pre;
          overflow-wrap: normal;
        }
        #codeEditor:focus { outline: none; }

        .status-bar { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00)); border-radius: 8px; margin-top: 15px; font-size: 12px; color: var(--muted); }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(2,6,10,0.6); justify-content: center; align-items: center; z-index: 1000; }
        .modal.active { display: flex; }
        .modal-content { background: linear-gradient(180deg, #0e1620, #071018); padding: 26px; border-radius: 12px; max-width: 540px; width: 92%; border: 1px solid rgba(124,92,255,0.06); }
        .modal-content h2 { margin-bottom: 16px; color: #f4fbff; }
        .modal-content pre { background: rgba(0,0,0,0.3); padding:12px; border-radius:6px; color:#e6eef3; font-family:monospace; margin-top: 8px; }


        .notification { position: fixed; top: 20px; right: 20px; padding: 12px 20px; border-radius: 10px; color: white; font-weight: 700; z-index: 2000; animation: slideIn 0.28s ease-out; box-shadow: 0 10px 30px rgba(2,6,12,0.6); }
        .notification.success { background: linear-gradient(90deg,var(--success),#36e092); }
        .notification.error { background: linear-gradient(90deg,#ff7b7b,var(--danger)); }

        @keyframes slideIn { from { transform: translateX(40px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        .output-panel {
          position: absolute;
          bottom: 0;
          left: 0;
          right: 0;
          height: 250px;
          background: rgba(8, 18, 10, 0.85);
          backdrop-filter: blur(10px);
          border-top: 1px solid rgba(88,217,107,0.1);
          transform: translateY(100%);
          transition: transform 0.3s ease-in-out;
          display: flex;
          flex-direction: column;
          border-bottom-left-radius: 10px;
          border-bottom-right-radius: 10px;
        }

        .output-panel.open {
          transform: translateY(0);
        }

        .output-toolbar { display:flex; justify-content:space-between; align-items:center; padding:10px 12px; border-bottom:1px solid rgba(88,217,107,0.1); color:var(--muted); font-weight:700; }
        .output-content { padding: 14px; flex-grow: 1; overflow:auto; font-family: 'Fira Code', monospace; font-size:14px; line-height:1.65; color: #e6f7ff; }
        .output-line { padding: 2px 0; }
        .output-line code { background: rgba(0,0,0,0.2); padding: 2px 5px; border-radius: 4px; color: var(--accent-2); }
        .output-log { color: #cbeef0; }
        .output-meta { color: #9aa7b2; font-style: italic; }
        .output-warn { color: #ffd580; }
        .output-error { color: #ff9b9b; }

        .ai-chat {
          position: fixed;
          right: 28px;
          top: 95px;
          width: 420px;
          height: calc(100vh - 125px);
          background: linear-gradient(180deg, #071423, #041219);
          border: 1px solid rgba(24,64,110,0.16);
          border-radius: 12px;
          box-shadow: 0 30px 80px rgba(2,10,30,0.7);
          display: flex;
          flex-direction: column;
          overflow: hidden;
          z-index: 10000;
          transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .ai-chat[aria-hidden="true"] { opacity: 0; transform: translateX(20px); pointer-events: none; }
        .ai-chat-header { padding: 12px 14px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid rgba(255,255,255,0.04); background: linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); }
        .ai-chat-body { padding: 14px; overflow:auto; flex:1; font-family: 'Fira Code', monospace; font-size:13px; color: #cfeef8; }
        
        .chat-attachments { padding: 0 12px 8px 12px; display: flex; flex-wrap:wrap; gap: 6px; }
        .attachment-item { background: rgba(255,255,255,0.05); padding: 5px 8px; border-radius: 6px; font-size: 12px; display:flex; align-items:center; gap: 5px; }
        .attachment-remove { background: none; border:none; color: #ff9b9b; cursor:pointer; font-size: 14px; }
        
        .ai-chat-input { display:flex; gap:8px; padding:12px; border-top:1px solid rgba(255,255,255,0.02); background: linear-gradient(180deg, rgba(0,0,0,0.06), rgba(0,0,0,0.02)); }
        .ai-chat-input textarea { flex:1; min-height:40px; resize:vertical; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.03); background: rgba(255,255,255,0.02); color: #e6f7ff; }
        
        .chat-line { margin-bottom:12px; padding:10px 12px; border-radius:8px; line-height: 1.6; }
        .chat-line:last-child { margin-bottom: 0; }
        .chat-user { background: rgba(255,255,255,0.02); color: #e6f7ff; }
        .chat-assistant { background: linear-gradient(90deg, rgba(34,94,182,0.18), rgba(23,64,140,0.12)); color: #dfffe8; border: 1px solid rgba(255,255,255,0.02); }
        .chat-assistant code { background-color: rgba(0,0,0,0.3); padding: 2px 4px; border-radius: 4px; color: #a6e22e; }
        .chat-assistant pre { background-color: rgba(0,0,0,0.4); padding: 10px; border-radius: 6px; margin: 8px 0; overflow-x: auto; }
        .chat-assistant pre code { background: none; padding: 0;}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>💻 Code-Genie 👻</h1>
            <div class="header-actions">
                <button class="btn btn-secondary" id="importLocalBtn">📂 Import</button>
                <input type="file" id="localFileInput" style="display:none" />
                <button class="btn btn-success" id="saveBtn">💾 Save</button>
                <button class="btn btn-primary" id="runBtn">▶ Run</button>
                <button class="btn btn-secondary" id="generateDocsBtn">📝 Generate Docs</button>
                <button class="btn btn-outline" id="exportBtn">⬇️ Export</button>
                <button class="btn btn-outline" id="toggleOutputBtn">Output</button>
                <button class="btn btn-outline" id="toggleChatBtn">Chatbot</button>
            </div>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <h3>📁 Files</h3>
                <ul class="file-list" id="fileList"></ul>
                <div class="new-file-section">
                    <h3>➕ New File</h3>
                    <input type="text" class="new-file-input" id="newFileName" placeholder="filename.js">
                    <button id="createBtn" class="btn btn-primary" style="width: 100%;">Create</button>
                </div>
            </div>

            <div class="editor-area">
                <div class="editor-toolbar">
                    <div>
                        <label style="margin-right: 10px; font-weight: 600; color: #cbd6dc;">Language:</label>
                        <select class="language-selector" id="languageSelect">
                            <option value="javascript">JavaScript</option>
                            <option value="python">Python</option>
                            <option value="html">HTML</option>
                            <option value="css">CSS</option>
                            <option value="java">Java</option>
                            <option value="c">C</option>
                            <option value="cpp">C++</option>
                            <option value="json">JSON</option>
                            <option value="sql">SQL</option>
                        </select>
                    </div>
                    <div style="color: #9fb3c8; font-size: 14px;">
                        Current: <strong id="currentFileName"></strong>
                    </div>
                </div>

                <div class="editor-wrapper">
                    <div class="editor-with-gutter">
                        <div class="gutter" id="gutter"></div>
                        <textarea id="codeEditor" spellcheck="false"></textarea>
                    </div>
                </div>

                <div class="status-bar">
                    <div>Lines: <strong id="lineCount">0</strong></div>
                    <div>Characters: <strong id="charCount">0</strong></div>
                    <div>Language: <strong id="currentLang">JavaScript</strong></div>
                </div>
            </div>
        </div>
    </div>

    <div class="output-panel" id="outputPanel">
        <div class="output-toolbar">
            <div>Output</div>
            <div>
                <button class="btn btn-secondary" id="clearOutputBtn">Clear</button>
            </div>
        </div>
        <div class="output-content" id="outputContent" tabindex="0"></div>
    </div>

    <div class="ai-chat" id="aiChat" aria-hidden="true">
        <div class="ai-chat-header">
            <strong>Assistant</strong>
            <button class="btn btn-outline" id="closeChatBtn">Close</button>
        </div>
        <div class="ai-chat-body" id="aiChatBody"></div>
        <div class="chat-attachments" id="chatAttachmentsContainer"></div>
        <div class="ai-chat-input">
            <button class="btn btn-secondary" id="attachFileBtn" title="Attach Files">📎</button>
            <input type="file" id="chatFileInput" style="display:none" multiple />
            <textarea id="aiInput" placeholder="Ask the assistant..."></textarea>
            <button class="btn btn-primary" id="sendAiBtn">Send</button>
        </div>
    </div>

    <div class="modal" id="compileModal">
        <div class="modal-content">
            <h2 id="compileTitle">Compile & Run</h2>
            <p id="compileDesc">Instructions to compile and run.</p>
            <pre id="compileCmd"></pre>
            <div style="display:flex; gap:10px; margin-top:12px; justify-content:flex-end;">
                <button class="btn btn-secondary" id="copyCmdBtn">Copy</button>
                <button class="btn btn-primary" id="downloadSourceBtn">Download</button>
                <button class="btn btn-outline" id="closeCompileModalBtn">Close</button>
            </div>
        </div>
    </div>
    
    <!-- NEW: Modal for creating file from language change -->
    <div class="modal" id="newFileFromLangModal">
        <div class="modal-content">
            <h2 id="newFileFromLangTitle">Create New File</h2>
            <p>Enter a name for the new file.</p>
            <input type="text" class="new-file-input" id="newFileFromLangName" placeholder="new_script.py" style="margin-top: 12px;">
            <div style="display:flex; gap:10px; margin-top:12px; justify-content:flex-end;">
                <button class="btn btn-primary" id="newFileFromLangCreateBtn">Create</button>
                <button class="btn btn-outline" id="newFileFromLangCancelBtn">Cancel</button>
            </div>
        </div>
    </div>


    <script type="module">
        // --- Gemini AI Configuration ---
        const GEMINI_API_KEY = ""; // PASTE YOUR GEMINI KEY HERE
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`;

        // --- Judge0 Code Execution API Configuration ---
        const JUDGE0_API_KEY = ""; // PASTE YOUR RAPIDAPI/JUDGE0 KEY HERE
        const JUDGE0_API_HOST = "judge0-ce.p.rapidapi.com";
        
        const ALLOWED_EXTENSIONS = [
            'js', 'jsx', 'ts', 'tsx', 'py', 'java', 'c', 'cpp', 'h', 'cs', 
            'html', 'htm', 'css', 'scss', 'json', 'xml', 'sql', 'md', 'txt', 
            'sh', 'rb', 'php', 'go'
        ];


        async function callGemini(prompt, retries = 3, delay = 1000) {
            if (!GEMINI_API_KEY) {
                const message = "API key is not configured. Please add your Gemini API key in the script to enable AI features.";
                appendChat('assistant', message);
                showNotification("AI features disabled: API key missing.", "error");
                return null;
            }
            try {
                const payload = { contents: [{ parts: [{ text: prompt }] }], };
                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    if (response.status === 429 && retries > 0) {
                        await new Promise(res => setTimeout(res, delay));
                        return callGemini(prompt, retries - 1, delay * 2);
                    }
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }
                const result = await response.json();
                const candidate = result.candidates?.[0];
                return candidate?.content?.parts?.[0]?.text || "Error: Could not extract text from the AI response.";
            } catch (error) {
                console.error('Error calling Gemini API:', error);
                return `An error occurred while contacting the AI assistant: ${error.message}`;
            }
        }

        async function executeCodeWithJudge0(sourceCode, languageId) {
            if (!JUDGE0_API_KEY) {
                showNotification("Code execution disabled: Judge0 API key missing.", "error");
                appendOutput("--- ERROR ---\nJudge0 API Key is not configured. Please add it to the script to run this language.", "error");
                return;
            }

            appendOutput(`--- Compiling & Running ${document.getElementById('languageSelect').value}... ---`, 'meta');
            const options = {
                method: 'POST',
                headers: {
                    'content-type': 'application/json',
                    'X-RapidAPI-Key': JUDGE0_API_KEY,
                    'X-RapidAPI-Host': JUDGE0_API_HOST
                },
                body: JSON.stringify({
                    language_id: languageId,
                    source_code: sourceCode
                })
            };

            try {
                const response = await fetch('https://judge0-ce.p.rapidapi.com/submissions?base64_encoded=false&wait=true', options);
                const result = await response.json();
                
                clearOutput();
                appendOutput(`--- Output ---`, 'meta');

                if (result.stdout) {
                    appendOutput(result.stdout, 'log');
                }
                if (result.stderr) {
                    appendOutput(result.stderr, 'error');
                }
                if (result.compile_output) {
                     appendOutput("--- Compile Error ---", "meta");
                     appendOutput(result.compile_output, 'error');
                }
                 appendOutput(`--- Finished (Time: ${result.time}s, Memory: ${result.memory}KB) ---`, 'meta');

            } catch (error) {
                console.error(error);
                appendOutput(`--- Error during execution ---\n${error.message}`, 'error');
            }
        }


        // --- Code Editor Logic ---
        let files = JSON.parse(localStorage.getItem('codeEditorFiles')) || {
            'welcome.js': {
                content: '// Welcome to Code-Genie!\n'
                    + '// I can help you code faster.\n\n'
                    + 'function greet(name) {\n'
                    + '    return "Hello, " + name + "! Welcome to your AI code editor.";\n'
                    + '}\n\n'
                    + 'const message = greet("Developer");\n'
                    + 'console.log(message);\n\n'
                    + '// Try the "Generate Docs" button or ask the Chatbot a question!',
                language: 'javascript'
            }
        };

        let currentFile = 'welcome.js';
        let chatAttachments = [];
        let previousLanguage = 'javascript'; 

        const codeEditor = document.getElementById('codeEditor');
        const fileList = document.getElementById('fileList');
        const gutter = document.getElementById('gutter');
        const localFileInput = document.getElementById('localFileInput');
        const attachFileBtn = document.getElementById('attachFileBtn');
        const chatFileInput = document.getElementById('chatFileInput');
        const chatAttachmentsContainer = document.getElementById('chatAttachmentsContainer');
        const outputPanel = document.getElementById('outputPanel');
        const outputContent = document.getElementById('outputContent');
        const aiChat = document.getElementById('aiChat');
        const aiChatBody = document.getElementById('aiChatBody');
        const aiInput = document.getElementById('aiInput');
        const sendAiBtn = document.getElementById('sendAiBtn');
        const closeChatBtn = document.getElementById('closeChatBtn');
        const compileModal = document.getElementById('compileModal');
        const newFileFromLangModal = document.getElementById('newFileFromLangModal');
        const newFileFromLangNameInput = document.getElementById('newFileFromLangName');


        function saveFilesToLocalStorage() {
            localStorage.setItem('codeEditorFiles', JSON.stringify(files));
        }

        function updateStats() {
            const content = codeEditor.value;
            const lines = content.split('\n').length;
            const chars = content.length;
            document.getElementById('lineCount').textContent = lines;
            document.getElementById('charCount').textContent = chars;
        }

        function renderLineNumbers() {
            if (!gutter) return;
            const content = codeEditor.value || '';
            const lines = content.split('\n').length;
            let html = '';
            for (let i = 1; i <= lines; i++) {
                html += `<span class="line-number">${i}</span>`;
            }
            gutter.innerHTML = html;
        }

        function syncScroll(event) {
            if (gutter) gutter.scrollTop = event.target.scrollTop;
        }
        
        codeEditor.addEventListener('scroll', syncScroll);

        function handleLanguageChange(event) {
            const newLanguage = event.target.value;
            const langExtensionMap = {
                'javascript': 'js', 'python': 'py', 'html': 'html', 'css': 'css', 
                'java': 'java', 'c': 'c', 'cpp': 'cpp', 'json': 'json', 'sql': 'sql'
            };
            previousLanguage = files[currentFile]?.language || 'javascript';
            newFileFromLangNameInput.placeholder = `new_script.${langExtensionMap[newLanguage] || 'txt'}`;
            newFileFromLangNameInput.value = '';
            newFileFromLangModal.classList.add('active');
            newFileFromLangNameInput.focus();
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        function saveFile() {
           if (!currentFile) return;
            files[currentFile] = {
                content: codeEditor.value,
                language: document.getElementById('languageSelect').value
            };
            saveFilesToLocalStorage();
            showNotification(`Saved ${currentFile} locally`, 'success');
        }

        function createNewFile(fileName, language) {
            if (!fileName) {
                showNotification('Please enter a filename', 'error');
                return false;
            }
            if (files[fileName]) {
                showNotification('File already exists', 'error');
                return false;
            }
            
            const langMap = { 'js': 'javascript', 'py': 'python', 'html': 'html', 'css': 'css', 'json': 'json', 'sql': 'sql', 'c': 'c', 'cpp': 'cpp', 'java': 'java' };
            const fileExtension = fileName.split('.').pop().toLowerCase();
            const detectedLang = language || langMap[fileExtension] || 'javascript';

            files[fileName] = { content: `// New file: ${fileName}`, language: detectedLang };
            saveFilesToLocalStorage();
            loadFile(fileName);
            showNotification(`Created ${fileName}`, 'success');
            return true;
        }

        function loadFile(fileName) {
           if (currentFile && files[currentFile]) {
                files[currentFile].content = codeEditor.value;
            }
            currentFile = fileName;
            
            const fileData = files[fileName];
            if (fileData) {
                codeEditor.value = fileData.content;
                document.getElementById('languageSelect').value = fileData.language;
                document.getElementById('currentFileName').textContent = fileName;
                document.getElementById('currentLang').textContent = fileData.language.charAt(0).toUpperCase() + fileData.language.slice(1);
                updateStats();
                renderLineNumbers();
            }
            
            renderFileList();
            codeEditor.focus();
        }

        function deleteFile(fileName) {
           if (confirm(`Delete ${fileName}?`)) {
                const wasCurrentFile = (currentFile === fileName);
                delete files[fileName];
                saveFilesToLocalStorage();

                if (wasCurrentFile) {
                    const remaining = Object.keys(files);
                    if (remaining.length > 0) {
                        loadFile(remaining[0]);
                    } else {
                        codeEditor.value = '';
                        currentFile = null;
                        document.getElementById('currentFileName').textContent = '';
                        updateStats();
                        renderLineNumbers();
                        renderFileList();
                    }
                } else {
                     renderFileList();
                }
                showNotification(`Deleted ${fileName}`, 'success');
            }
        }

        function renderFileList() {
           fileList.innerHTML = '';
            for (const fileName in files) {
                const li = document.createElement('li');
                li.className = 'file-item';
                if(fileName === currentFile) {
                    li.classList.add('active');
                }
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = fileName;
                nameSpan.addEventListener('click', () => loadFile(fileName));

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.textContent = '🗑️';
                deleteBtn.addEventListener('click', (e) => { e.stopPropagation(); deleteFile(fileName); });
                
                li.appendChild(nameSpan);
                li.appendChild(deleteBtn);
                fileList.appendChild(li);
            }
        }

        function runCode() {
            const code = codeEditor.value;
            const language = document.getElementById('languageSelect').value;
            openOutput();
            clearOutput();

            const langIdMap = {
                'python': 71,
                'c': 50,
                'cpp': 54,
                'java': 62
            };

            if (language in langIdMap) {
                 executeCodeWithJudge0(code, langIdMap[language]);
            } else if (language === 'javascript') {
                const originalConsole = { log: console.log, error: console.error, warn: console.warn };
                try {
                    appendOutput('--- Running JavaScript ---', 'meta');
                    console.log = (...args) => appendOutput(args.join(' '), 'log');
                    console.error = (...args) => appendOutput(args.join(' '), 'error');
                    console.warn = (...args) => appendOutput(args.join(' '), 'warn');
                    eval(code);
                    appendOutput('--- Execution finished ---', 'meta');
                } catch (error) {
                    appendOutput(error.message || String(error), 'error');
                    showNotification('Error detected!', 'error');
                } finally {
                    console.log = originalConsole.log;
                    console.error = originalConsole.error;
                    console.warn = originalConsole.warn;
                }
            } else if (language === 'html') {
                const newWindow = window.open();
                newWindow.document.write(code);
            } else {
                appendOutput(`Running ${language} is not supported.`, 'warn');
            }
        }

        function appendOutput(text, type = 'log') {
            if(text === null || text === undefined) return;
            const line = document.createElement('div');
            line.className = `output-line output-${type}`;
            line.textContent = text;
            outputContent.appendChild(line);
            outputContent.scrollTop = outputContent.scrollHeight;
        }

        function appendChat(role, text) {
            const el = document.createElement('div');
            el.className = `chat-line chat-${role}`;
            const formattedText = text
                .replace(/```(javascript|js|html|css|python)?\n([\s\S]*?)```/g, (match, lang, code) => `<pre><code>${code.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</code></pre>`)
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>');
            el.innerHTML = formattedText;
            aiChatBody.appendChild(el);
            aiChatBody.scrollTop = aiChatBody.scrollHeight;
        }
        
        function renderAttachments() {
            chatAttachmentsContainer.innerHTML = '';
            chatAttachments.forEach((file, index) => {
                const item = document.createElement('div');
                item.className = 'attachment-item';
                item.textContent = file.name;
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'attachment-remove';
                removeBtn.innerHTML = '&times;';
                removeBtn.onclick = () => {
                    chatAttachments.splice(index, 1);
                    renderAttachments();
                };
                item.appendChild(removeBtn);
                chatAttachmentsContainer.appendChild(item);
            });
        }
        
        function handleFileAttachment(event) {
            const newFiles = Array.from(event.target.files);
            newFiles.forEach(file => {
                const fileExtension = file.name.split('.').pop().toLowerCase();
                if (!ALLOWED_EXTENSIONS.includes(fileExtension)) {
                    showNotification(`Cannot attach .${fileExtension} files.`, 'error');
                    return; 
                }
                const reader = new FileReader();
                reader.onload = (e) => {
                    chatAttachments.push({
                        name: file.name,
                        content: e.target.result
                    });
                    renderAttachments();
                };
                reader.readAsText(file);
            });
            chatFileInput.value = '';
        }

        function clearOutput() { if (outputContent) outputContent.innerHTML = ''; }
        function openOutput() { if (outputPanel) outputPanel.classList.add('open'); }
        function toggleOutput() { if (outputPanel) outputPanel.classList.toggle('open'); }
        
        function toggleChat(forceOpen = false) {
           if (!aiChat) return;
            const isHidden = aiChat.getAttribute('aria-hidden') === 'true';
            if (forceOpen) {
                 aiChat.setAttribute('aria-hidden', 'false');
            } else {
                 aiChat.setAttribute('aria-hidden', isHidden ? 'false' : 'true');
            }
        }

        async function generateDocumentation() {
           const code = codeEditor.value;
            if (!code.trim()) {
                showNotification('Cannot document an empty file', 'error');
                return;
            }
            const language = files[currentFile].language;
            const prompt = `Generate technical documentation in Markdown for the following ${language} code. Describe its purpose, functions, and usage.\n\n---\n\n${code}`;
            showNotification('Generating documentation...', 'success');
            openOutput();
            clearOutput();
            appendOutput('--- Generating Documentation (AI) ---', 'meta');
            const documentation = await callGemini(prompt);
            
            if (!documentation) {
                clearOutput();
                appendOutput("Could not generate documentation. Please configure your API key.", "error");
                return;
            }

            clearOutput();
            appendOutput('--- AI Generated Documentation ---', 'meta');
            const docElement = document.createElement('div');
            docElement.className = 'output-line';
            docElement.innerHTML = documentation
                .replace(/### (.*)/g, '<h3>$1</h3>')
                .replace(/## (.*)/g, '<h2>$1</h2>')
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/^- (.*)/gm, '<li>$1</li>')
                .replace(/\n/g, '<br>');
            outputContent.appendChild(docElement);
        }

        function handleLocalFileSelect(e) {
            const file = e.target.files && e.target.files[0];
            if (!file) return;

            const fileExtension = file.name.split('.').pop().toLowerCase();
            if (!ALLOWED_EXTENSIONS.includes(fileExtension)) {
                showNotification(`File type .${fileExtension} is not supported.`, 'error');
                localFileInput.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(evt) {
                const content = evt.target.result;
                const filename = file.name;
                if (files[filename] && !confirm(`${filename} already exists. Overwrite?`)) {
                    localFileInput.value = '';
                    return;
                }
                const lang = filename.split('.').pop().toLowerCase();
                const langMap = { 'js': 'javascript', 'py': 'python', 'html': 'html', 'css': 'css', 'json': 'json', 'sql': 'sql', 'c': 'c', 'cpp': 'cpp', 'java': 'java' };
                files[filename] = { content, language: langMap[lang] || 'javascript' };
                saveFilesToLocalStorage();
                loadFile(filename);
                showNotification(`Imported ${filename}`, 'success');
                localFileInput.value = '';
            };
            reader.readAsText(file);
        }

        function exportCurrentFile() {
            if (!currentFile || !files[currentFile]) {
                showNotification('No file to export', 'error');
                return;
            }
            const content = files[currentFile].content || codeEditor.value || '';
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = currentFile;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
            showNotification(`Exported ${currentFile}`, 'success');
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('importLocalBtn').addEventListener('click', () => document.getElementById('localFileInput').click());
            document.getElementById('saveBtn').addEventListener('click', saveFile);
            document.getElementById('runBtn').addEventListener('click', runCode);
            document.getElementById('exportBtn').addEventListener('click', exportCurrentFile);
            document.getElementById('toggleOutputBtn').addEventListener('click', toggleOutput);
            document.getElementById('toggleChatBtn').addEventListener('click', () => toggleChat());
            document.getElementById('generateDocsBtn').addEventListener('click', generateDocumentation);
            document.getElementById('clearOutputBtn').addEventListener('click', clearOutput);
            if (closeChatBtn) closeChatBtn.addEventListener('click', () => aiChat.setAttribute('aria-hidden', 'true'));
            
            attachFileBtn.addEventListener('click', () => chatFileInput.click());
            chatFileInput.addEventListener('change', handleFileAttachment);
            
            if (sendAiBtn) sendAiBtn.addEventListener('click', async () => {
                const text = aiInput.value.trim();
                if (!text && chatAttachments.length === 0) return;
                
                let prompt = text;
                
                if (chatAttachments.length > 0) {
                    let attachmentsContent = "\n\n--- Attached Files ---\n";
                    chatAttachments.forEach(file => {
                        attachmentsContent += `\n**File: ${file.name}**\n\`\`\`\n${file.content}\n\`\`\`\n`;
                    });
                    prompt += attachmentsContent;
                }

                appendChat('user', text || `Attached ${chatAttachments.map(f=>f.name).join(', ')}`);
                aiInput.value = '';
                chatAttachments = [];
                renderAttachments();

                const codeContext = codeEditor.value;
                prompt += `\n--- Current Editor Content (${currentFile}) ---\n${codeContext}`;

                const thinking = document.createElement('div');
                thinking.className = 'chat-line chat-assistant';
                thinking.textContent = 'Thinking...';
                aiChatBody.appendChild(thinking);
                aiChatBody.scrollTop = aiChatBody.scrollHeight;

                const reply = await callGemini(prompt);
                thinking.remove();
                if (reply) appendChat('assistant', reply);
            });

            document.getElementById('createBtn').addEventListener('click', () => {
                const fileName = document.getElementById('newFileName').value.trim();
                 if (createNewFile(fileName)) {
                    document.getElementById('newFileName').value = '';
                }
            });
            document.getElementById('newFileName').addEventListener('keydown', (e) => { 
                if (e.key === 'Enter') {
                    const fileName = document.getElementById('newFileName').value.trim();
                    if(createNewFile(fileName)) {
                        document.getElementById('newFileName').value = '';
                    }
                } 
            });
            
            // New modal listeners
            document.getElementById('newFileFromLangCreateBtn').addEventListener('click', () => {
                const newFileName = newFileFromLangNameInput.value.trim();
                const newLanguage = document.getElementById('languageSelect').value;
                if(createNewFile(newFileName, newLanguage)) {
                    newFileFromLangModal.classList.remove('active');
                }
            });

            document.getElementById('newFileFromLangCancelBtn').addEventListener('click', () => {
                newFileFromLangModal.classList.remove('active');
                // Revert language dropdown to what it was before opening the modal
                document.getElementById('languageSelect').value = previousLanguage;
            });


            document.getElementById('closeCompileModalBtn').addEventListener('click', () => compileModal.classList.remove('active'));
            document.getElementById('localFileInput').addEventListener('change', handleLocalFileSelect);
            document.getElementById('languageSelect').addEventListener('change', handleLanguageChange);
            codeEditor.addEventListener('input', () => { updateStats(); renderLineNumbers(); });
            document.addEventListener('keydown', (e) => { if ((e.ctrlKey || e.metaKey) && e.key === 's') { e.preventDefault(); saveFile(); } });

            loadFile(currentFile);
        });
    </script>
</body>
</html>

